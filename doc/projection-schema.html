<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Projection Schema - App Framework Spec</title>
  <link rel="stylesheet" href="css/styles.css">
</head>

<body>
  <div class="container">
    <aside class="sidebar">
      <h1>App Framework Spec</h1>
      <nav>
        <ul>
          <li class="section-header">Overview</li>
          <li><a href="index.html"><span class="status-dot ready"></span>Introduction</a></li>
          <li><a href="architecture.html"><span class="status-dot ready"></span>Architecture Overview</a></li>
          <li><a href="roadmap.html"><span class="status-dot unreviewed"></span>Implementation Roadmap</a></li>

          <li class="section-header">Model</li>
          <li><a href="projection-schema.html" class="active"><span class="status-dot ready"></span>Projection Schema</a></li>
          <li><a href="client-classes.html"><span class="status-dot unreviewed"></span>Client Class Generation</a></li>

          <li class="section-header">Core Framework</li>
          <li><a href="event-system.html"><span class="status-dot unreviewed"></span>Event System</a></li>
          <li><a href="client-model.html"><span class="status-dot unreviewed"></span>Client Model</a></li>
          <li><a href="binding.html"><span class="status-dot unreviewed"></span>Data Binding</a></li>
          <li><a href="view-layer.html"><span class="status-dot unreviewed"></span>View Layer</a></li>

          <li class="section-header">Server Integration</li>
          <li><a href="server-sync.html"><span class="status-dot unreviewed"></span>Server Sync Layer</a></li>
          <li><a href="matlab-controller.html"><span class="status-dot unreviewed"></span>MATLAB Controller</a></li>
          <li><a href="service-layer.html"><span class="status-dot unreviewed"></span>Service Layer</a></li>

          <li class="section-header">Design Decisions</li>
          <li><a href="open-issues.html"><span class="status-dot unreviewed"></span>Open Issues</a></li>
          <li><a href="coding-guidelines.html"><span class="status-dot unreviewed"></span>Coding Guidelines</a></li>
        </ul>
      </nav>
    </aside>

    <main class="main-content">
      <div class="page-header">
        <h1>Projection Schema</h1>
        <nav class="page-nav">
          <a href="#use-cases" class="page-nav-item">Use Cases</a>
          <a href="#requirements" class="page-nav-item">Requirements</a>
          <a href="#design" class="page-nav-item">Architectural Design</a>
        </nav>
      </div>

      <p>The <strong>projection schema</strong> defines the format for <strong>projection map files</strong> (JSON
        documents) that specify how MATLAB objects are mapped to JavaScript client model classes. We use the
        <strong>PKPD.Analysis</strong> object as our primary example, which presents several synchronization challenges
        that illustrate the key use cases.</p>

      <h2 id="use-cases">Use Cases</h2>

      <p>gPKPDSim Configuration Tool enable users to set up a <strong>PKPD.Analysis</strong> object for use within the main gPKPDSim app.</p>

      <h3>Use Case 1: Property Subset Selection</h3>
      <p>Not all properties of a MATLAB object should be synchronized to the client. Projection map files must allow
        selecting a <strong>subset of properties</strong> to sync.</p>

      <div class="callout callout-info">
        <h4>Characteristics</h4>
        <ul>
          <li>MATLAB objects contain both UI-relevant properties and properties not needed on the client</li>
          <li>The projection map explicitly lists which properties to project</li>
          <li>Allows filtering out large result data that would be expensive to serialize and transfer</li>
        </ul>
      </div>

      <div class="callout callout-example">
        <h4>Example</h4>
        <p>The <code>Analysis</code> object contains configuration settings that the UI needs (e.g.,
          <code>StopTime</code>, <code>SelectedSpecies</code>) as well as properties that are not needed on the client
          (e.g., results data like <code>SimData</code>, <code>FitResults</code>).</p>
      </div>

      <p>Once we have identified the properties to sync, each property falls into one of three categories based on its
        type:</p>

      <h3>Use Case 2: Simple Properties</h3>
      <p>Properties with <strong>primitive values</strong> (numbers, strings, booleans) or simple arrays that can be
        serialized directly to JSON without transformation.</p>

      <div class="callout callout-info">
        <h4>Characteristics</h4>
        <ul>
          <li>Value can be directly converted to JSON</li>
          <li>No nested object structure</li>
          <li>No transformation required</li>
        </ul>
      </div>

      <div class="callout callout-example">
        <h4>Example</h4>
        <p>The <code>Analysis</code> object has simple properties like <code>StopTime</code> (number), <code>Task</code>
          (string), and <code>StartTime</code> (number) that can be sent directly to the client.</p>
      </div>

      <h3>Use Case 3: Hierarchical Object Properties</h3>
      <p>Properties that are <strong>objects or arrays of objects owned by the parent object</strong>. These owned
        objects are themselves hierarchical and require their own projection.</p>

      <div class="callout callout-info">
        <h4>Characteristics</h4>
        <ul>
          <li>The parent object <strong>owns</strong> the child object (composition relationship)</li>
          <li>The child object may itself contain nested objects that need projection</li>
          <li>Cannot serialize the entire object graph (circular references, function handles)</li>
          <li>Must recursively define which properties of the child to extract</li>
        </ul>
      </div>

      <div class="callout callout-example">
        <h4>Example</h4>
        <p>The <code>Analysis</code> object owns a <code>SimBiology.Model</code>, which itself contains
          <code>Species</code>, <code>Parameters</code>, <code>Compartments</code>, and other nested objects that need
          their own projection schemas.</p>
      </div>

      <h3>Use Case 4: Reference Properties</h3>
      <p>Properties that hold <strong>references to objects owned elsewhere</strong> in the object hierarchy. These are
        not owned by the property holder but point to objects that exist in another part of the hierarchy.</p>

      <div class="callout callout-info">
        <h4>Characteristics</h4>
        <ul>
          <li>The property holds a reference (or array of references) to objects owned by another object</li>
          <li>The referenced objects are already projected as part of their owner's hierarchy</li>
          <li>Only the <strong>SessionID</strong> should be sent, not the full object (to avoid duplication)</li>
          <li>The client uses SessionID to match references against the full object collection</li>
        </ul>
      </div>

      <div class="callout callout-example">
        <h4>Example</h4>
        <p>The <code>Analysis.SelectedSpecies</code> property is an array of references to species objects that are
          owned by <code>Analysis.Model</code>. Instead of duplicating the full species data, only the SessionID values
          are sent.</p>
      </div>

      <h2 id="requirements">Requirements</h2>

      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Requirement</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>R-PropertySubset</td>
            <td>Projection maps must support property subset selection (explicitly list which properties to project)
            </td>
          </tr>
          <tr>
            <td>R-PrimitiveProperty</td>
            <td>Projection maps must support simple property mapping (primitive values directly to JSON)</td>
          </tr>
          <tr>
            <td>R-NestedSchema</td>
            <td>Projection maps must support referencing other projection maps to handle hierarchical objects</td>
          </tr>
          <tr>
            <td>R-ReferenceProperty</td>
            <td>Projection maps must allow objects to define which property to use as reference ID (e.g., SessionID)
            </td>
          </tr>
          <tr>
            <td>R-PropertyPermissions</td>
            <td>Projection maps must specify property mutability (ReadOnly in MATLAB, Writable by client app)</td>
          </tr>
          <tr>
            <td>R-MultipleSchemas</td>
            <td>Multiple projection maps can be defined for the same MATLAB object to support different applications
            </td>
          </tr>
          <tr>
            <td>R-JSONFormat</td>
            <td>Projection map files must be JSON for easy parsing in both MATLAB and JavaScript</td>
          </tr>
          <tr>
            <td>R-HumanReadable</td>
            <td>Projection maps must be human-readable and self-documenting</td>
          </tr>
          <tr>
            <td>R-GracefulHandling</td>
            <td>Projection must handle missing/null source properties gracefully</td>
          </tr>
          <tr>
            <td>R-PropertyNames</td>
            <td>Property names should match MATLAB property names to make JavaScript objects feel like the original
              MATLAB objects</td>
          </tr>
          <tr>
            <td>NR-CrossLanguageRename</td>
            <td><strong>Non-Requirement:</strong> Do not need to specify different property names across languages
              (JavaScript should use MATLAB property names)</td>
          </tr>
        </tbody>
      </table>

      <h2 id="design">Architectural Design</h2>

      <h3>Example</h3>

      <h4>Referenced Projection Map (example)</h4>
      <div class="callout callout-example">
        <p>Example projection map for the root model object:</p>
        <pre><code class="language-json">{
  "MATLABClass": "PKPD.Analysis",
  "JSClass": "gPKPDSim_Analysis",
  "Properties": {
    "StopTime": {
      "Type": "number"
    },
    "Model": {
      "Type": "ModelProjection",
      "ClientReadOnly": true
    },
    "SelectedSpecies": {
      "Type": "SpeciesProjection",
      "IsArray": true,
      "IsReference": true
    }
  },
  "ProjectionMaps": {
    "ModelProjection": "shared/model-projection/model.json",
    "SpeciesProjection": "shared/model-projection/species.json"
  }
}</code></pre>
        <p>The referenced <code>shared/model-projection/species.json</code> file:</p>
        <pre><code class="language-json">{
  "MATLABClass": "SimBiology.Species",
  "JSClass": "SimBiology_Species",
  "ReferenceIDProperty": "SessionID",
  "Properties": {
    "SessionID": {
      "Type": "number",
      "ReadOnly": true
    },
    "Name": {
      "Type": "string",
      "ClientReadOnly": true
    },
    "InitialAmount": {
      "Type": "number",
      "ClientReadOnly": false
    },
    "Units": {
      "Type": "string",
      "ClientReadOnly": false
    }
  }
}</code></pre>
      </div>

      <h3>Projection Schema Format</h3>
      <p>The projection schema defines the structure of projection map files. Each projection map is a JSON document
        that specifies how to transform a MATLAB object into a JavaScript client model.</p>

      <h4>Schema Properties</h4>

      <table>
        <thead>
          <tr>
            <th>Property</th>
            <th>Type</th>
            <th>Required</th>
            <th>Default</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><code>MATLABClass</code></td>
            <td>String</td>
            <td>Yes</td>
            <td>-</td>
            <td>The fully qualified MATLAB class name (e.g., <code>"PKPD.Analysis"</code>). This is the object being
              projected.</td>
          </tr>
          <tr>
            <td><code>JSClass</code></td>
            <td>string</td>
            <td>Yes</td>
            <td>-</td>
            <td>The JavaScript class name (e.g., <code>"gPKPDSim_Analysis"</code>).</td>
          </tr>
          <tr>
            <td><code>Properties</code></td>
            <td>object</td>
            <td>Yes</td>
            <td>-</td>
            <td>A map of property definitions. Each key is the JavaScript property name, and the value is a property
              definition object (see Property Definition Fields below).</td>
          </tr>
          <tr>
            <td><code>ProjectionMaps</code></td>
            <td>object</td>
            <td>No</td>
            <td><code>{}</code></td>
            <td>Maps type names to external projection map file paths. Used when a property references another
              projection map.</td>
          </tr>
          <tr>
            <td><code>ReferenceIDProperty</code></td>
            <td>String</td>
            <td>No</td>
            <td><code>null</code></td>
            <td>The property name to use as the reference ID for this object type (e.g., <code>"SessionID"</code>).
              Required if this object can be referenced by other objects.</td>
          </tr>
        </tbody>
      </table>

      <h4>Property Definition Fields</h4>

      <p>Each property in the <code>Properties</code> object is defined by its key (the property name) and a definition
        object with the following fields:</p>

      <table>
        <thead>
          <tr>
            <th>Field</th>
            <th>Type</th>
            <th>Required</th>
            <th>Default</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><code>Type</code></td>
            <td>string</td>
            <td>Yes</td>
            <td>-</td>
            <td>JavaScript primitive type (<code>"number"</code>, <code>"string"</code>, <code>"boolean"</code>,
              <code>"object"</code>) or a projection map type name. If not a primitive type, must be defined in
              <code>ProjectionMaps</code>.</td>
          </tr>
          <tr>
            <td><code>IsArray</code></td>
            <td>boolean</td>
            <td>No</td>
            <td><code>false</code></td>
            <td>Set to <code>true</code> if the property is an array</td>
          </tr>
          <tr>
            <td><code>IsReference</code></td>
            <td>boolean</td>
            <td>No</td>
            <td><code>false</code></td>
            <td>Set to <code>true</code> if this property holds references to objects owned elsewhere. Only the
              reference ID will be sent</td>
          </tr>
          <tr>
            <td><code>ReadOnly</code></td>
            <td>boolean</td>
            <td>No</td>
            <td><code>false</code></td>
            <td>Set to <code>true</code> if the property has <code>SetAccess=private</code> in MATLAB (cannot be set
              from outside the class)</td>
          </tr>
          <tr>
            <td><code>ClientReadOnly</code></td>
            <td>boolean</td>
            <td>No</td>
            <td>Same as <code>ReadOnly</code></td>
            <td>Set to <code>true</code> if this client application should not be allowed to modify this property. If
              <code>false</code>, client can write to this property</td>
          </tr>
        </tbody>
      </table>


      <h2>Related Pages</h2>
      <p><span class="badge badge-open">TODO</span></p>
      <ul>
        <li><a href="client-classes.html">Client Class Generation</a></li>
        <li><a href="server-sync.html">Server Sync Layer</a> - How projections are executed</li>
        <li><a href="client-model.html">Client Model</a> - Client-side data layer</li>
      </ul>
    </main>
  </div>
</body>

</html>